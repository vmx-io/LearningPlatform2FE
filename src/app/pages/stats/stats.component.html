<div class="stats-wrap" *ngIf="loading()">Loading stats…</div>

<div class="stats-wrap" *ngIf="!loading() && data() as s">
  <h1>Your Statistics</h1>

  <section class="cards">
    <div class="card">
      <div class="k">Total answers</div>
      <div class="v">{{ s.totalAnswers }}</div>
    </div>
    <div class="card">
      <div class="k">Accuracy (overall)</div>
      <div class="v">{{ (s.accuracyOverall ?? 0) | number:'1.0-2' }}%</div>
    </div>
    <div class="card">
      <div class="k">Answers (last 30d)</div>
      <div class="v">{{ s.answersLast30d }}</div>
    </div>
    <div class="card">
      <div class="k">Accuracy (last 30d)</div>
      <div class="v">{{ (s.accuracyLast30d ?? 0) | number:'1.0-2' }}%</div>
    </div>
    <div class="card">
      <div class="k">Exams (completed)</div>
      <div class="v">{{ s.completedExams }} / {{ s.totalExams }}</div>
    </div>
    <div class="card">
      <div class="k">Avg exam score</div>
      <div class="v">{{ (s.averageScore ?? 0) | number:'1.0-2' }}%</div>
    </div>
    <div class="card" *ngIf="s.passedExams != null">
      <div class="k">Exams (passed)</div>
      <div class="v">{{ s.passedExams }}</div>
    </div>
    <div class="card" *ngIf="s.failedExams != null">
      <div class="k">Exams (failed)</div>
      <div class="v">{{ s.failedExams }}</div>
    </div>
    <div class="card" *ngIf="s.passRate != null">
      <div class="k">Pass rate</div>
      <div class="v">{{ s.passRate | number:'1.0-2' }}%</div>
    </div>
  </section>

  <!-- <section class="table">
    <h2>Accuracy by tag</h2>
    <table *ngIf="tagRows().length; else noTags">
      <thead>
        <tr>
          <th>Tag</th>
          <th>Answered</th>
          <th>Accuracy</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let r of tagRows()">
          <td>{{ r.tag }}</td>
          <td>{{ r.answered }}</td>
          <td>{{ r.accuracy | number:'1.0-2' }}%</td>
        </tr>
      </tbody>
    </table>
    <ng-template #noTags>
      <p>No tag data yet — answer a few questions first.</p>
    </ng-template>
  </section> -->

  <!-- NEW: My Exams -->
  <section class="my-exams">
    <div class="head">
      <h2>My Exams</h2>
      <div class="pager">
        <button (click)="loadPage(page()-1)" [disabled]="!hasPrev()">◀ Prev</button>
        <span>Page {{ page() }} / {{ pagesTotal() }}</span>
        <button (click)="loadPage(page()+1)" [disabled]="!hasNext()">Next ▶</button>
      </div>
    </div>

    <div *ngIf="examsLoading()">Loading exams…</div>
    <div *ngIf="!examsLoading() && examsError()" class="err">{{ examsError() }}</div>

    <table *ngIf="!examsLoading() && exams() as ex">
      <thead>
        <tr>
          <th>Started</th>
          <th>Finished</th>
          <th>Questions</th>
          <th>Score</th>
          <th>Status</th>
          <th>Review</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let e of ex.items">
          <td>{{ e.startedAt | date:'yyyy-MM-dd HH:mm' }}</td>
          <td>{{ e.finishedAt ? (e.finishedAt | date:'yyyy-MM-dd HH:mm') : '—' }}</td>
          <td>{{ e.questionCount }}</td>
          <td>{{ toPercent(e.scorePercent) }}</td>
          <td>
            <span [class.ok]="e.passed" [class.bad]="e.passed === false">
              {{ e.passed ? 'Passed' : (e.passed === false ? 'Failed' : '—') }}
            </span>
          </td>
          <td>
            <a [routerLink]="['/exam', e.id, 'review']">Open</a>
          </td>
        </tr>
      </tbody>
    </table>
  </section>
</div>

<p class="err" *ngIf="error()">{{ error() }}</p>
