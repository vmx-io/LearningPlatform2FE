<div class="stats-wrap" *ngIf="loading()">Loading stats…</div>

<div class="stats-wrap" *ngIf="!loading() && data() as s">
  <h1>Your Statistics</h1>

  <!-- KPI Cards -->
  <section class="cards">
    <div class="card">
      <div class="k">Total answers</div>
      <div class="v">{{ s.totalAnswers }}</div>
    </div>
    <div class="card">
      <div class="k">Accuracy (overall)</div>
      <div class="v">{{ (s.accuracyOverall ?? 0) | number:'1.0-2' }}%</div>
    </div>
    <div class="card">
      <div class="k">Answers (last 30d)</div>
      <div class="v">{{ s.answersLast30d }}</div>
    </div>
    <div class="card">
      <div class="k">Accuracy (last 30d)</div>
      <div class="v">{{ (s.accuracyLast30d ?? 0) | number:'1.0-2' }}%</div>
    </div>
    <div class="card">
      <div class="k">Exams (completed)</div>
      <div class="v">{{ s.completedExams }} / {{ s.totalExams }}</div>
    </div>
    <div class="card">
      <div class="k">Avg exam score</div>
      <div class="v">{{ (s.averageScore ?? 0) | number:'1.0-2' }}%</div>
    </div>
    <div class="card" *ngIf="s.passedExams != null">
      <div class="k">Exams (passed)</div>
      <div class="v">{{ s.passedExams }}</div>
    </div>
    <div class="card" *ngIf="s.failedExams != null">
      <div class="k">Exams (failed)</div>
      <div class="v">{{ s.failedExams }}</div>
    </div>
    <div class="card" *ngIf="s.passRate != null">
      <div class="k">Pass rate</div>
      <div class="v">{{ s.passRate | number:'1.0-2' }}%</div>
    </div>
  </section>

  <!-- Per-Category Progress -->
  <section class="table">
    <h2>Progress by category</h2>

    <div *ngIf="tagsLoading()">Loading categories…</div>
    <p class="err" *ngIf="tagsError()">{{ tagsError() }}</p>

    <table *ngIf="!tagsLoading() && !tagsError() && tagRows().length; else noTags">
      <thead>
        <tr>
          <th>Category</th>
          <th>Available Qs</th>
          <th>Answered</th>
          <th>Accuracy</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let r of tagRows()">
          <td>{{ r.tag }}</td>
          <td>{{ r.available }}</td>
          <td>{{ r.answered }}</td>
          <td>{{ r.accuracy | number:'1.0-2' }}%</td>
          <td><button (click)="pickTag(r.tag)">View details</button></td>
        </tr>
      </tbody>
    </table>

    <ng-template #noTags>
      <p>No category data yet — answer a few questions first.</p>
    </ng-template>
  </section>

  <!-- Per-Category Detail -->
  <section class="by-tag" *ngIf="selectedTag() as tag">
    <div class="head">
      <h2>Category: {{ tag }}</h2>
      <div class="controls">
        <label>
          Window:
          <select [ngModel]="windowDays()" (ngModelChange)="changeWindowDays($event)">
            <option [ngValue]="7">Last 7 days</option>
            <option [ngValue]="30">Last 30 days</option>
            <option [ngValue]="90">Last 90 days</option>
            <option [ngValue]="365">Last 365 days</option>
            <option [ngValue]="9999">All time</option>
          </select>
        </label>
      </div>
    </div>

    <div *ngIf="detailLoading()">Loading…</div>
    <p class="err" *ngIf="detailError()">{{ detailError() }}</p>

    <div class="cards slim" *ngIf="!detailLoading() && detail() as d">
      <div class="card">
        <div class="k">Answers (window)</div>
        <div class="v">{{ d.totalAnswers }}</div>
      </div>
      <div class="card">
        <div class="k">Accuracy (window)</div>
        <div class="v">{{ (d.accuracy ?? 0) | number:'1.0-2' }}%</div>
      </div>
      <div class="card">
        <div class="k">Distinct exams (window)</div>
        <div class="v">{{ d.completedExams }}</div>
      </div>
      <div class="card" *ngIf="selectedSummaryRow() as sr">
        <div class="k">All-time answered</div>
        <div class="v">{{ sr.answered }}</div>
      </div>
      <div class="card" *ngIf="selectedSummaryRow() as sr">
        <div class="k">All-time accuracy</div>
        <div class="v">{{ sr.accuracy | number:'1.0-2' }}%</div>
      </div>
    </div>
  </section>

  <!-- My Exams -->
  <section class="my-exams">
    <div class="head">
      <h2>My Exams</h2>
      <div class="pager">
        <button (click)="loadPage(page()-1)" [disabled]="!hasPrev()">◀ Prev</button>
        <span>Page {{ page() }} / {{ pagesTotal() }}</span>
        <button (click)="loadPage(page()+1)" [disabled]="!hasNext()">Next ▶</button>
      </div>
    </div>

    <div *ngIf="examsLoading()">Loading exams…</div>
    <div *ngIf="!examsLoading() && examsError()" class="err">{{ examsError() }}</div>

    <table *ngIf="!examsLoading() && exams() as ex">
      <thead>
        <tr>
          <th>Started</th>
          <th>Finished</th>
          <th>Questions</th>
          <th>Score</th>
          <th>Status</th>
          <th>Review</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let e of ex.items">
          <td>{{ e.startedAt | date:'yyyy-MM-dd HH:mm' }}</td>
          <td>{{ e.finishedAt ? (e.finishedAt | date:'yyyy-MM-dd HH:mm') : '—' }}</td>
          <td>{{ e.questionCount }}</td>
          <td>{{ toPercent(e.scorePercent) }}</td>
          <td>
            <span [class.ok]="e.passed" [class.bad]="e.passed === false">
              {{ e.passed ? 'Passed' : (e.passed === false ? 'Failed' : '—') }}
            </span>
          </td>
          <td>
            <a [routerLink]="['/exam', e.id, 'review']">Open</a>
          </td>
        </tr>
      </tbody>
    </table>
  </section>
</div>

<p class="err" *ngIf="error()">{{ error() }}</p>
