<!-- PICKER: choose category -->
<div *ngIf="mode() === 'picker'" class="learn-wrap">
  <div *ngIf="mode() === 'picker'" class="learn-picker">
    <h2 style="text-align: center;">Choose a category</h2>

    <div *ngIf="loading()">Loading…</div>

    <ng-container *ngIf="!loading()">
      <div class="tag-cards">
        <div class="card" *ngFor="let t of tags()">
          <button (click)="startWithTag(t.tag)">
            <div class="tag-name">{{ t.tag }}</div>
            <div class="tag-count">({{ t.count }})</div>
          </button>
        </div>
      </div>

      <h2 style="text-align: center;">Or...</h2>

      <div class="all-actions">
        <button class="secondary" (click)="startAll()">Start with all questions</button>
      </div>
    </ng-container>
  </div>
</div>


<!-- LEARN: your existing UI -->
<div *ngIf="mode() === 'learn'">
  <div class="learn-header">
    <button class="secondary" (click)="backToPicker()">← Back to categories</button>
    <span class="tag-label" *ngIf="selectedTag()">Category: <strong>{{ selectedTag() }}</strong></span>
    <span class="tag-label" *ngIf="!selectedTag()">All questions</span>
  </div>

  <div *ngIf="loading()">Loading questions…</div>

  <div *ngIf="!loading() && q as q" class="learn-wrap">
    <section class="question">
      <div class="q-meta">
        <h2>Question {{ currentIdx() + 1 }} / {{ questions().length }}</h2>
        <small>{{ q.multiSelect ? 'Select all that apply' : 'Select one' }}</small>
      </div>

      <div class="q-text">{{ q.questionText }}</div>

      <ul class="options">
        <li *ngFor="let opt of q.options">
          <label>
            <input
              type="{{ q.multiSelect ? 'checkbox' : 'radio' }}"
              name="opt-{{ currentIdx() }}"
              [checked]="isSelected(opt.id)"
              (change)="toggle(opt.id)"
            />
            {{ opt.text }}
          </label>

          <section *ngIf="feedback() as fb">
            <div
              class="option-explanation"
              [ngClass]="{
                correct: fb.correct.includes(opt.id),
                wrong: isSelected(opt.id) && !fb.correct.includes(opt.id)
              }"
            >
              <span [innerHTML]="fb.explanations[opt.id]?.text | formatExplanation"></span>
              <a
                *ngIf="fb.explanations[opt.id]?.url"
                [href]="fb.explanations[opt.id].url"
                target="_blank"
                rel="noopener"
              >
                source
              </a>
            </div>
          </section>
        </li>
      </ul>

      <div class="actions">
        <button (click)="submit()">Check</button>
        <button class="secondary" (click)="resetCurrent()">Reset</button>
        <button class="secondary" (click)="showExplanation()">Detailed explanation</button>
      </div>

      <!-- Voting Module -->
      <div class="voting-module">
        <div class="voting-buttons">
          <button 
            class="vote-btn upvote"
            [class.active]="hasVoted() && currentVote() === true"
            [disabled]="votingLoading()"
            (click)="upvote()"
            title="Upvote this question">
            +
          </button>
          <button 
            class="vote-btn downvote"
            [class.active]="hasVoted() && currentVote() === false"
            [disabled]="votingLoading()"
            (click)="downvote()"
            title="Downvote this question">
            −
          </button>
        </div>
        <div class="trust-score">
          Trust Score: <span class="score-value">{{ trustScore() }}</span>
        </div>
      </div>

      <!-- Comments Section -->
      <app-comments-section *ngIf="currentQuestionId()" [questionId]="currentQuestionId()!"></app-comments-section>

      <section *ngIf="feedback() as fb" class="feedback">
        <p class="result">
          <strong>Result:</strong>
          <span [class.ok]="fb.isCorrect" [class.bad]="!fb.isCorrect">
            {{ fb.isCorrect ? 'Correct ✅' : 'Incorrect ❌' }}
          </span>
        </p>

        <p *ngIf="!fb.isCorrect" class="correct-line">
          Correct answers:
          <code>{{ fb.correct.join(', ').toUpperCase() }}</code>
        </p>
      </section>
    </section>

    <!-- Footer Navigation -->
    <footer class="learn-footer">
      <div class="nav-row">
        <button (click)="prev()" [disabled]="currentIdx() === 0">◀ Previous</button>
        <button (click)="openJump()">Jump to</button>
        <button (click)="random()">Random</button>

        <div class="window">
          <button
            *ngFor="let i of pageWindow()"
            [class.active]="i === currentIdx()"
            (click)="goTo(i)"
          >
            {{ i + 1 }}
          </button>
        </div>

        <button (click)="next()" [disabled]="currentIdx() === questions().length - 1">
          Next ▶
        </button>
      </div>
    </footer>
  </div>
</div>

<!-- Jump to Question Modal -->
<div *ngIf="showJump()" class="modal-overlay" (click)="closeJump()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Jump to Question</h3>
      <button class="close-button" (click)="closeJump()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="jump-modal-content">
        <p class="jump-instruction">Enter the question number you want to jump to:</p>
        <div class="input-container">
          <input 
            type="number" 
            [(ngModel)]="jumpValueStr" 
            placeholder="Enter question number"
            min="1" 
            [max]="questions().length"
            class="jump-input"
            (keydown.enter)="confirmJump()"
            (keydown.escape)="closeJump()"
            #jumpInput
            (click)="$event.stopPropagation()">
          <div class="input-hint">Range: 1 - {{ questions().length }}</div>
        </div>
        <div class="modal-actions">
          <button class="secondary" (click)="closeJump()">Cancel</button>
          <button (click)="confirmJump()">Jump to Question</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Explanation Popup Modal -->
<div *ngIf="showExplanationModal()" class="modal-overlay" (click)="closeExplanation()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Detailed Explanation</h3>
      <button class="close-button" (click)="closeExplanation()">&times;</button>
    </div>
    <div class="modal-body">
      <div *ngIf="explanationLoading()" class="loading">Loading explanation...</div>
      <div *ngIf="!explanationLoading() && explanationContent()" 
           class="explanation-content" 
           [innerHTML]="explanationContent()">
      </div>
      <div *ngIf="!explanationLoading() && !explanationContent()" class="no-explanation">
        No detailed explanation available for this question.
      </div>
    </div>
  </div>
</div>
