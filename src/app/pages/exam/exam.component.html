<div class="exam-wrap" *ngIf="!examId(); else started">
    <section class="how-to card">
        <h2>How to take an exam</h2>
      
        <p class="lead">
          This mock exam simulates the real test conditions. You can choose the number
          of questions and duration before starting.
        </p>
      
        <details open>
          <summary>üìù Exam format</summary>
          <ul>
            <li>Multiple-choice and multi-select questions.</li>
            <li>Each question shows possible answers (A, B, C, D).</li>
            <li>Select the answer(s) and click <strong>Save answer</strong>.</li>
            <li>Saved answers turn the button green with ‚ÄúAnswer saved‚Äù.</li>
          </ul>
        </details>
      
        <details>
          <summary>‚è± Timer</summary>
          <ul>
            <li>The countdown starts when the exam begins.</li>
            <li>You can see remaining time at the top of the page.</li>
            <li>When time runs out, the exam automatically finishes.</li>
          </ul>
        </details>
      
        <details>
          <summary>üìç Navigation</summary>
          <ul>
            <li>Use <strong>Prev</strong> / <strong>Next</strong> to move between questions.</li>
            <li>Click numbers in the navigation bar to jump to specific questions.</li>
            <li>Click the <strong>Map</strong> button to see all questions at once ‚Äî
              answered ones are highlighted green.</li>
          </ul>
        </details>
      
        <details>
          <summary>üéØ Scoring</summary>
          <ul>
            <li>Each correct answer is worth 1 point.</li>
            <li>Unanswered questions are counted as incorrect.</li>
            <li>Passing score: <strong>61%</strong>.</li>
          </ul>
        </details>
      
        <details>
          <summary>üíæ Saving progress</summary>
          <ul>
            <li>Your progress is saved locally as you answer questions.</li>
            <li>You can refresh or close the page and continue later, as long as the
                timer hasn't expired.</li>
          </ul>
        </details>
      </section>
    <p>Start a new exam (defaults are for development; adjust as you like).</p>
  
    <form class="start-form" (submit)="$event.preventDefault(); startExam()">
        <label>
          Questions:
          <input
            type="number"
            min="1"
            [ngModel]="countInput()"
            (ngModelChange)="countInput.set(+$event || 1)"
            [ngModelOptions]="{standalone: true}"
          />
        </label>
        <label>
          Duration (sec):
          <input
            type="number"
            min="60"
            step="60"
            [ngModel]="durationInput()"
            (ngModelChange)="durationInput.set(+$event || 60)"
            [ngModelOptions]="{standalone: true}"
          />
        </label>
        <button [disabled]="loading()">Start Exam</button>
      </form>
  
    <p *ngIf="error()" class="err">{{ error() }}</p>
  </div>
  
  <ng-template #started>
    <div class="exam-wrap" *ngIf="q as q">
      <header class="exam-header">
        <div class="timer">
          ‚è± {{ formatTime() }}
          <div class="bar"><div class="fill" [style.width.%]="progressPct()"></div></div>
          <small>{{ currentIdx()+1 }} / {{ questions().length }}</small>
        </div>
        <div class="nav">
          <button (click)="prev()" [disabled]="currentIdx() === 0">‚óÄ Prev</button>
  
          <div class="window">
            <button
              *ngFor="let i of pageWindow()"
              [class.active]="i === currentIdx()"
              (click)="goTo(i)"
            >
              {{ i + 1 }}
            </button>
          </div>

          <button (click)="openMap()">Map</button>
  
          <button (click)="next()" [disabled]="currentIdx() === questions().length - 1">Next ‚ñ∂</button>
        </div>
      </header>
  
      <section class="question">
        <div class="q-text">{{ q.questionText }}</div>
        <ul class="options">
          <li *ngFor="let opt of q.options">
            <label>
              <input
                type="{{ q.multiSelect ? 'checkbox' : 'radio' }}"
                name="opt-{{ currentIdx() }}"
                [checked]="isSelected(opt.id)"
                (change)="toggle(opt.id)"
              />
              <strong>{{ opt.id.toUpperCase() }}.</strong> {{ opt.text }}
            </label>
          </li>
        </ul>
  
        <div class="actions">
            <button
            (click)="submitCurrent()"
            [class.saved]="savedByIdx()[currentIdx()]"
          >
            {{ savedByIdx()[currentIdx()] ? 'Answer saved' : 'Save answer' }}
          </button>
  
          <button class="danger" (click)="finishExam()">Finish exam</button>
        </div>
  
        <p *ngIf="error()" class="err">{{ error() }}</p>
      </section>
    </div>

    <!-- Questions Map Modal -->
<div class="modal-backdrop" *ngIf="showMap()">
    <div class="modal modal-map">
      <div class="modal-head">
        <h3>Questions ({{ questions().length }})</h3>
        <button class="secondary" (click)="closeMap()">‚úï</button>
      </div>
  
      <div class="grid">
        <button
          *ngFor="let i of allIndices()"
          (click)="goToFromMap(i)"
          [class.current]="i === currentIdx()"
          [class.answered]="isAnswered(i)"
          [title]="'Question ' + (i+1)"
        >
          {{ i + 1 }}
        </button>
      </div>
  
      <div class="legend">
        <span class="dot current"></span> Current
        <span class="dot answered"></span> Answered
      </div>
    </div>
  </div>
  </ng-template>
  